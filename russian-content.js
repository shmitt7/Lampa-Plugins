(function(){'use strict';if(window.russian_content_plugin_ready)return;window.russian_content_plugin_ready=true;const MIN_MOVIE_RUNTIME=71;const MIN_CARTOON_RUNTIME=70;const MAIN_PAGE_RESULTS=20;const MAX_PAGES=500;const CACHE_LIFE_HOURS=24;const PARTS_LIMIT=4;const network=new Lampa.Reguest();function getDates(){const today=new Date();const todayStr=today.getFullYear()+'-'+String(today.getMonth()+1).padStart(2,'0')+'-'+String(today.getDate()).padStart(2,'0');const oneMonthAgo=new Date(today);oneMonthAgo.setMonth(oneMonthAgo.getMonth()-1);const oneMonthAgoStr=oneMonthAgo.getFullYear()+'-'+String(oneMonthAgo.getMonth()+1).padStart(2,'0')+'-'+String(oneMonthAgo.getDate()).padStart(2,'0');const oneYearAgo=new Date(today);oneYearAgo.setFullYear(oneYearAgo.getFullYear()-1);const oneYearAgoStr=oneYearAgo.getFullYear()+'-'+String(oneYearAgo.getMonth()+1).padStart(2,'0')+'-'+String(oneYearAgo.getDate()).padStart(2,'0');return{todayStr,oneMonthAgoStr,oneYearAgoStr};} function buildApiUrl(query){return Lampa.TMDB.api(query+'&api_key='+Lampa.TMDB.key()+'&language=ru');} function deduplicate(results){const unique=[];const seenIds=new Set();results.forEach(item=>{const key=item.id+'_'+(item.name?'tv':'movie');if(!seenIds.has(key)){seenIds.add(key);unique.push(item);}});unique.sort((a,b)=>(b.popularity||0)-(a.popularity||0));return unique;} function loadContent(queries,title,onComplete){let results=[];let loaded=0;queries.forEach(query=>{network.silent(buildApiUrl(query),json=>{results=results.concat(json.results||[]);if(++loaded===queries.length){const unique=deduplicate(results);onComplete(Lampa.Utils.addSource({results:unique.slice(0,MAIN_PAGE_RESULTS),source:'tmdb',title:title,total_pages:2,params:{card:{card_small:true}}},'tmdb'));}},()=>{if(++loaded===queries.length)onComplete(Lampa.Utils.addSource({results:[],source:'tmdb',title:title,total_pages:1,params:{card:{card_small:true}}},'tmdb'));},false,{cache:{life:CACHE_LIFE_HOURS}});});} function loadSimple(query,title,onComplete){network.silent(buildApiUrl(query),json=>{onComplete(Lampa.Utils.addSource({results:json.results||[],source:'tmdb',title:title,total_pages:2,params:{card:{card_small:true}}},'tmdb'));},()=>{onComplete(Lampa.Utils.addSource({results:[],source:'tmdb',title:title,total_pages:1,params:{card:{card_small:true}}},'tmdb'));},false,{cache:{life:CACHE_LIFE_HOURS}});} function getQueries(){const dates=getDates();return{nowWatching:['discover/movie?with_original_language=ru&with_runtime.gte='+MIN_MOVIE_RUNTIME+'&primary_release_date.gte='+dates.oneMonthAgoStr+'&primary_release_date.lte='+dates.todayStr+'&sort_by=popularity.desc&page=1','discover/tv?with_original_language=ru&first_air_date.gte='+dates.oneMonthAgoStr+'&first_air_date.lte='+dates.todayStr+'&sort_by=popularity.desc&page=1'],yearPopular:['discover/movie?with_original_language=ru&with_runtime.gte='+MIN_MOVIE_RUNTIME+'&primary_release_date.gte='+dates.oneYearAgoStr+'&primary_release_date.lte='+dates.todayStr+'&sort_by=popularity.desc&page=1','discover/tv?with_original_language=ru&first_air_date.gte='+dates.oneYearAgoStr+'&first_air_date.lte='+dates.todayStr+'&sort_by=popularity.desc&page=1'],movies:'discover/movie?with_original_language=ru&with_runtime.gte='+MIN_MOVIE_RUNTIME+'&primary_release_date.lte='+dates.todayStr+'&sort_by=primary_release_date.desc',series:'discover/tv?with_original_language=ru&without_genres=16&first_air_date.lte='+dates.todayStr+'&sort_by=first_air_date.desc',cartoons:'discover/movie?with_original_language=ru&with_genres=16&with_runtime.gte='+MIN_CARTOON_RUNTIME+'&primary_release_date.lte='+dates.todayStr+'&sort_by=primary_release_date.desc',cartoonSeries:'discover/tv?with_original_language=ru&with_genres=16&first_air_date.lte='+dates.todayStr+'&sort_by=first_air_date.desc',reality:'discover/tv?with_original_language=ru&with_genres=10764&first_air_date.lte='+dates.todayStr+'&sort_by=first_air_date.desc',talkShow:'discover/tv?with_original_language=ru&with_genres=10767&first_air_date.lte='+dates.todayStr+'&sort_by=first_air_date.desc',documentary:'discover/tv?with_original_language=ru&with_genres=99&first_air_date.lte='+dates.todayStr+'&sort_by=first_air_date.desc'};} function russianComponent(object){const comp=Lampa.Maker.make('Main',object);const queries=getQueries();const parts_data=[call=>loadContent(queries.nowWatching,'Сейчас смотрят',call),call=>loadContent(queries.yearPopular,'Популярное за год',call),call=>loadSimple(queries.movies,'Русские фильмы',call),call=>loadSimple(queries.series,'Русские сериалы',call),call=>loadSimple(queries.cartoons,'Русские мультфильмы',call),call=>loadSimple(queries.cartoonSeries,'Русские мультсериалы',call),call=>loadSimple(queries.reality,'Русские реалити-шоу',call),call=>loadSimple(queries.talkShow,'Русские ток-шоу',call),call=>loadSimple(queries.documentary,'Русские документальные',call)];comp.use({onCreate:function(){this.activity.loader(true);Lampa.Api.partNext(parts_data,PARTS_LIMIT,data=>{this.build(data);this.activity.loader(false);this.activity.toggle();},this.empty.bind(this));},onNext:function(resolve,reject){if(parts_data.filter(p=>typeof p==='function').length)Lampa.Api.partNext(parts_data,PARTS_LIMIT,resolve,reject);else reject();},onInstance:function(item,data){item.use({onMore:function(){const routes={'Сейчас смотрят':{component:'russian_now_watching_full',url:''},'Популярное за год':{component:'russian_year_popular_full',url:''},'Русские фильмы':{component:'category_full',url:queries.movies},'Русские сериалы':{component:'category_full',url:queries.series},'Русские мультфильмы':{component:'category_full',url:queries.cartoons},'Русские мультсериалы':{component:'category_full',url:queries.cartoonSeries},'Русские реалити-шоу':{component:'category_full',url:queries.reality},'Русские ток-шоу':{component:'category_full',url:queries.talkShow},'Русские документальные':{component:'category_full',url:queries.documentary}};const route=routes[data.title];if(route)Lampa.Activity.push({url:route.url,title:data.title,component:route.component,page:1,source:'tmdb'});},onInstance:function(card,card_data){card.use({onEnter:Lampa.Router.call.bind(Lampa.Router,'full',card_data),onFocus:()=>{Lampa.Background.change(Lampa.Utils.cardImgBackground(card_data));}});}});}});return comp;} function loadDateRangePage(dateFrom,dateTo,page,onSuccess){let results=[];let loaded=0;const apiPage=Math.ceil(page/2);['movie','tv'].forEach(type=>{const dateParam=type==='movie'?'primary_release_date':'first_air_date';const runtimeFilter=type==='movie'?'&with_runtime.gte='+MIN_MOVIE_RUNTIME:'';network.silent(buildApiUrl('discover/'+type+'?with_original_language=ru'+runtimeFilter+'&'+dateParam+'.gte='+dateFrom+'&'+dateParam+'.lte='+dateTo+'&sort_by=popularity.desc&page='+apiPage),json=>{results=results.concat(json.results||[]);if(++loaded===2)onSuccess({results:deduplicate(results),total_pages:MAX_PAGES});},()=>{if(++loaded===2)onSuccess({results:deduplicate(results),total_pages:MAX_PAGES});},false,{cache:{life:CACHE_LIFE_HOURS}});});} function createPaginationComponent(dateFrom,dateTo){return function(object){const comp=Lampa.Utils.createInstance(Lampa.Maker.get('Category'),object,{module:Lampa.Maker.module('Category').toggle(Lampa.Maker.module('Category').MASK.base,'Pagination')});comp.use({onCreate:function(){this.activity.loader(true);loadDateRangePage(dateFrom,dateTo,object.page||1,data=>{this.build(data);comp.render().find('.category-full').addClass('cols--6');this.activity.loader(false);this.activity.toggle();});},onNext:function(resolve){object.page=(object.page||1)+1;loadDateRangePage(dateFrom,dateTo,object.page,resolve);},onInstance:function(card,card_data){card.use({onEnter:Lampa.Router.call.bind(Lampa.Router,'full',card_data),onFocus:()=>{Lampa.Background.change(Lampa.Utils.cardImgBackground(card_data));}});}});return comp;};} function initComponents(){const dates=getDates();Lampa.Component.add('russian_category',russianComponent);Lampa.Component.add('russian_now_watching_full',createPaginationComponent(dates.oneMonthAgoStr,dates.todayStr));Lampa.Component.add('russian_year_popular_full',createPaginationComponent(dates.oneYearAgoStr,dates.todayStr));} function addRussianMenu(){const button=$(`<li class="menu__item selector"><div class="menu__ico"><svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 35 35"><path d="M7.486,33.076a3.164,3.164,0,0,1-3.164-3.165V5.089A3.164,3.164,0,0,1,9.249,2.461L27.754,14.872a3.165,3.165,0,0,1,0,5.256L9.249,32.539h0A3.156,3.156,0,0,1,7.486,33.076ZM8.552,31.5h0ZM7.491,4.422a.7.7,0,0,0-.317.08.652.652,0,0,0-.352.587V29.911a.664.664,0,0,0,1.034.552L26.362,18.052a.66.66,0,0,0,.294-.553.646.646,0,0,0-.294-.55L7.856,4.537A.649.649,0,0,0,7.491,4.422Z" fill="currentColor"/></svg></div><div class="menu__text">Русское</div></li>`);button.on('hover:enter',()=>{Lampa.Activity.push({url:'',title:'Русский контент',component:'russian_category',page:1});});$('.menu .menu__list').eq(0).append(button);} function init(){initComponents();addRussianMenu();} if(window.appready)init();else Lampa.Listener.follow('app',e=>{if(e.type==='ready')init();});})();
